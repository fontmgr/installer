#!/usr/bin/env bash
# shellcheck shell=bash
# - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version           :  202602200031-git
# @Author            :  Jason Hempstead
# @Contact           :  jason@casjaysdev.pro
# @License           :  WTFPL
# @ReadME            :  incusmgr --help
# @Copyright         :  Copyright: (c) 2025 Jason Hempstead, Casjays Developments
# @Created           :  Thursday, Feb 20, 2025 00:31 EST
# @File              :  incusmgr
# @Description       :  incus script to manage containers and VMs
# @Changelog         :  New script
# @TODO              :
# @Other             :
# @Resource          :
# - - - - - - - - - - - - - - - - - - - - - - - - -
# shellcheck disable=SC1001,SC2003,SC1003,SC2016,SC2031,SC2120,SC2155,SC2199,SC2317,SC2329
# - - - - - - - - - - - - - - - - - - - - - - - - -
APPNAME="$(basename -- "$0" 2>/dev/null)"
VERSION="202602200031-git"
USER="${SUDO_USER:-$USER}"
RUN_USER="${RUN_USER:-$USER}"
USER_HOME="${USER_HOME:-$HOME}"
SRC_DIR="${BASH_SOURCE%/*}"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Set bash options
if [ "$1" == "--debug" ]; then shift 1 && set -xo pipefail && export SCRIPT_OPTS="--debug" && export _DEBUG="on"; fi
trap '__trap_exit' EXIT
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Set script title
#CASJAYS_DEV_TILE_FORMAT="${USER}@${HOSTNAME}:${PWD/#$HOME/~} - $APPNAME"
#CASJAYSDEV_TITLE_PREV="${CASJAYSDEV_TITLE_PREV:-${CASJAYSDEV_TITLE_SET:-$APPNAME}}"
#[ -z "$CASJAYSDEV_TITLE_SET" ] && printf '\033]0;%s\007' "$CASJAYS_DEV_TILE_FORMAT" && CASJAYSDEV_TITLE_SET="$APPNAME"
export CASJAYSDEV_TITLE_PREV="${CASJAYSDEV_TITLE_PREV:-${CASJAYSDEV_TITLE_SET:-$APPNAME}}" CASJAYSDEV_TITLE_SET
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Import functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}/functions"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/main/functions}"
# - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE"
else
  echo "Can not load the functions file: $SCRIPTSFUNCTDIR/$SCRIPTSFUNCTFILE" 1>&2
  exit 90
fi
# - - - - - - - - - - - - - - - - - - - - - - - - -
# user system devenv dfmgr dockermgr fontmgr iconmgr pkmgr systemmgr thememgr wallpapermgr
user_install && __options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
__list_available() { echo -e "$LIST" | tr ' ' '\n' && exit 0; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__cmd_exists() {
  local exitCode=0
  [ -n "$1" ] || return 0
  for cmd in "$@"; do
    if builtin command -v "$cmd" &>/dev/null; then
      exitCode=$((exitCode + 0))
    else
      exitCode=$((exitCode + 1))
    fi
  done
  [ $exitCode -eq 0 ] || exitCode=3
  return ${exitCode:-0}
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__am_i_online() {
  local INCUSMGR_EXIT_STATUS=0
  curl -q -LSsfI --max-time 1 --retry 0 "${1:-https://1.1.1.1}" 2>&1 | grep -qi 'server:.*cloudflare' || INCUSMGR_EXIT_STATUS=4
  return ${INCUSMGR_EXIT_STATUS:-0}
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__user_is_root() {
  { [ $(id -u) -eq 0 ] || [ $EUID -eq 0 ] || [ "$WHOAMI" = "root" ]; } && return 0 || return 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__user_is_not_root() {
  if { [ $(id -u) -eq 0 ] || [ $EUID -eq 0 ] || [ "$WHOAMI" = "root" ]; }; then return 1; else return 0; fi
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__sudo_group() {
  grep -sh "${1:-$USER}" "/etc/group" | grep -Eq 'wheel|adm|sudo' || return 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__sudoask() {
  ask_for_password sudo true && return 0 || return 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__sudorun() {
  __sudoif && __cmd_exists sudo && sudo -HE "$@" || { __sudoif && eval "$@"; }
  return $?
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__can_i_sudo() {
  (sudo -vn && sudo -ln) 2>&1 | grep -vq 'may not' >/dev/null && return 0
  __sudo_group "${1:-$USER}" || __sudoif || __sudo true &>/dev/null || return 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__sudoif() {
  __user_is_root && return 0
  __can_i_sudo "${RUN_USER:-$USER}" && return 0
  __user_is_not_root && __sudoask && return 0 || return 1
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
requiresudo() {
  if [ "$CMD_EXISTS_REQUIRE_SUDO" = "yes" ] && [ -z "$CMD_EXISTS_REQUIRE_SUDO_RUN" ]; then
    export CMD_EXISTS_REQUIRE_SUDO="no"
    export CMD_EXISTS_REQUIRE_SUDO_RUN="true"
    __sudo "$@"
    exit $?
  else
    return 0
  fi
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__sudo() {
  CMD="${1:-echo}" && shift 1
  CMD_ARGS="${*:--e "${RUN_USER:-$USER}"}"
  SUDO="$(builtin command -v sudo 2>/dev/null || echo 'eval')"
  [ "$(basename -- "$SUDO" 2>/dev/null)" = "sudo" ] && OPTS="--preserve-env=PATH -HE"
  if __sudoif; then
    export PATH="$PATH"
    $SUDO ${OPTS:-} $CMD $CMD_ARGS && true || false
    exitCode=$?
  else
    printf '%s\n' "This requires root to run"
    exitCode=1
  fi
  return ${exitCode:-1}
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__printf_head() { printf_blue "$1"; }
__printf_opts() { printf_purple "$1"; }
__printf_line() { printf_cyan "$1"; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__help() {
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
  __printf_opts "incusmgr:  Comprehensive Incus container and VM management tool - $VERSION"
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
  __printf_line "Usage: incusmgr [options] [command] [arguments...]"
  __printf_line " - "
  __printf_line "Container/VM Management Commands:"
  __printf_line "run <image>                     - Launch an Incus container from the specified image"
  __printf_line "launch <image> <name>           - Launch and name an Incus container"
  __printf_line "exec <instance> <command>       - Execute a command in a running instance"
  __printf_line "enter <instance>                - Enter an instance with an interactive shell"
  __printf_line "shell <instance>                - Open shell in instance (alias for enter)"
  __printf_line "stop <instance>                 - Stop a running instance"
  __printf_line "start <instance>                - Start a stopped instance"
  __printf_line "restart <instance>              - Restart an instance"
  __printf_line "delete <instance>               - Delete an instance (supports --force flag)"
  __printf_line "list [filter]                   - List instances with optional filtering"
  __printf_line "info <instance>                 - Show detailed information about an instance"
  __printf_line "rename <old> <new>              - Rename an instance"
  __printf_line "snapshot <instance> [name]      - Create a snapshot of an instance"
  __printf_line "restore <instance> <snapshot>   - Restore instance from snapshot"
  __printf_line " - "
  __printf_line "System Management Commands:"
  __printf_line "init [force]                    - Initialize incusmgr configuration"
  __printf_line "status                          - Show Incus daemon status and information"
  __printf_line "version                         - Show Incus version information"
  __printf_line "storage list                    - List storage pools"
  __printf_line "storage create <name>           - Create a storage pool"
  __printf_line "storage delete <name>           - Delete a storage pool"
  __printf_line "network list                    - List networks"
  __printf_line "network create <name>           - Create a network"
  __printf_line "network delete <name>           - Delete a network"
  __printf_line "network show <name>             - Show network details and IPs"
  __printf_line "profile list                    - List profiles"
  __printf_line "profile show <name>             - Show profile configuration"
  __printf_line "profile create <name>           - Create a new profile"
  __printf_line "profile delete <name>           - Delete a profile"
  __printf_line " - "
  __printf_line "Image Management Commands:"
  __printf_line "image list [remote:]            - List available images"
  __printf_line "image info <image>              - Show image information"
  __printf_line "image delete <image>            - Delete an image"
  __printf_line "image copy <src> <dst>          - Copy image between remotes"
  __printf_line "remote list                     - List configured remotes"
  __printf_line "remote add <name> <url>         - Add a remote server"
  __printf_line "remote remove <name>            - Remove a remote server"
  __printf_line " - "
  __printf_line "Cleanup Commands:"
  __printf_line "prune                           - Clean up stopped instances and unused volumes"
  __printf_line "prune instances                 - Remove all stopped instances"
  __printf_line "prune volumes                   - Remove unused storage volumes"
  __printf_line "prune images                    - Remove unused images"
  __printf_line "prune all                       - Remove all (instances, volumes, and images)"
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
  __printf_opts "Other Options"
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
  __printf_line "--help                          - Shows this message"
  __printf_line "--config                        - Generate user config file"
  __printf_line "--version                       - Show script version"
  __printf_line "--options                       - Shows all available options"
  __printf_line "--debug                         - Enables script debugging"
  __printf_line "--raw                           - Removes all formatting on output"
  __printf_line "--force                         - Force operations, bypass safety checks"
  __printf_line ""
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
  __printf_line "Examples:"
  __printf_line "incusmgr init                   - Initialize Incus environment"
  __printf_line "incusmgr launch ubuntu:22.04    - Launch Ubuntu 22.04 container"
  __printf_line "incusmgr list                   - List all instances"
  __printf_line "incusmgr enter mycontainer      - Enter container shell"
  __printf_line "incusmgr network show incusbr0  - Show network details"
  __printf_line "incusmgr prune all              - Clean up everything"
  __printf_head "- - - - - - - - - - - - - - - - - - - - - - - - -"
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__gen_config() {
  [ "$INIT_CONFIG" = "TRUE" ] || printf_green "Generating the config file in"
  [ "$INIT_CONFIG" = "TRUE" ] || printf_green "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE"
  [ -d "$INCUSMGR_CONFIG_DIR" ] || mkdir -p "$INCUSMGR_CONFIG_DIR"
  [ -d "$INCUSMGR_CONFIG_BACKUP_DIR" ] || mkdir -p "$INCUSMGR_CONFIG_BACKUP_DIR"
  [ -f "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE" ] &&
    cp -Rf "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE" "$INCUSMGR_CONFIG_BACKUP_DIR/$INCUSMGR_CONFIG_FILE.$$"
  cat <<EOF >"$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE"
# Settings for incusmgr
INCUSMGR_INCUS_BIN="${INCUSMGR_INCUS_BIN:-incus}"
INCUSMGR_DEFAULT_STORAGE="${INCUSMGR_DEFAULT_STORAGE:-default}"
INCUSMGR_DEFAULT_NETWORK="${INCUSMGR_DEFAULT_NETWORK:-incusbr0}"
INCUSMGR_DEFAULT_PROFILE="${INCUSMGR_DEFAULT_PROFILE:-default}"

# Notification settings
INCUSMGR_GOOD_MESSAGE="${INCUSMGR_GOOD_MESSAGE:-Everything Went OK}"
INCUSMGR_ERROR_MESSAGE="${INCUSMGR_ERROR_MESSAGE:-Well something seems to have gone wrong}"
INCUSMGR_NOTIFY_ENABLED="${INCUSMGR_NOTIFY_ENABLED:-yes}"
INCUSMGR_NOTIFY_CLIENT_NAME="${NOTIFY_CLIENT_NAME:-$APPNAME}"
INCUSMGR_NOTIFY_CLIENT_ICON="${NOTIFY_CLIENT_ICON:-$INCUSMGR_NOTIFY_CLIENT_ICON}"

# Colorization settings
INCUSMGR_OUTPUT_COLOR="${INCUSMGR_OUTPUT_COLOR:-5}"
INCUSMGR_OUTPUT_COLOR_GOOD="${INCUSMGR_OUTPUT_COLOR_GOOD:-2}"
INCUSMGR_OUTPUT_COLOR_ERROR="${INCUSMGR_OUTPUT_COLOR_ERROR:-1}"

EOF

  if [ -f "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE" ]; then
    [ "$INIT_CONFIG" = "TRUE" ] || printf_green "Your config file for $APPNAME has been created"
    exitCode=0
  else
    printf_red "Failed to create the config file"
    exitCode=1
  fi
  return ${exitCode:-0}
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__trap_exit() {
  exitCode=${exitCode:-$?}
  [ -n "$INCUSMGR_TEMP_FILE" ] && [ -f "$INCUSMGR_TEMP_FILE" ] && rm -Rf "$INCUSMGR_TEMP_FILE" &>/dev/null
  if builtin type -t __trap_exit_local | grep -q 'function'; then __trap_exit_local; fi
  return $exitCode
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__cd() { \builtin cd "$1" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__incus() { eval $INCUSMGR_INCUS_BIN "$@" 2>"$INCUSMGR_TEMP_FILE" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__instance_exists() { incus list -c n -f csv 2>/dev/null | grep -q "^$1$" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__instance_is_running() { incus list -c ns -f csv 2>/dev/null | grep "^$1," | grep -q ",RUNNING$" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__storage_exists() { incus storage list -f csv -c n 2>/dev/null | grep -q "^$1$" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__network_exists() { incus network list -f csv -c n 2>/dev/null | grep -q "^$1$" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__profile_exists() { incus profile list -f csv -c n 2>/dev/null | grep -q "^$1$" || return 1; }
# - - - - - - - - - - - - - - - - - - - - - - - - -
__prune_instances() {
  local instances="$(incus list -c n -f csv 2>/dev/null | grep '^')"
  local count=0
  if [ -n "$instances" ]; then
    printf_cyan "Removing all instances..."
    while IFS= read -r instance; do
      [ -z "$instance" ] && continue
      printf_blue "  Deleting instance: $instance"
      if incus delete "$instance" --force &>/dev/null; then
        printf_green "    ✓ Deleted $instance"
        count=$((count + 1))
      else
        printf_red "    ✗ Failed to delete $instance"
      fi
    done <<<"$instances"
    printf_green "Removed $count instance(s)"
  else
    printf_yellow "No instances to remove"
  fi
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__prune_volumes() {
  local storage="${1:-$INCUSMGR_DEFAULT_STORAGE}"
  local volumes="$(incus storage volume list "$storage" -f csv -c n 2>/dev/null | grep -v '^default$' | grep '^')"
  local count=0
  if [ -n "$volumes" ]; then
    printf_cyan "Removing storage volumes from pool: $storage..."
    while IFS= read -r volume; do
      [ -z "$volume" ] && continue
      printf_blue "  Deleting volume: $volume"
      if incus storage volume delete "$storage" "$volume" &>/dev/null; then
        printf_green "    ✓ Deleted $volume"
        count=$((count + 1))
      else
        printf_red "    ✗ Failed to delete $volume"
      fi
    done <<<"$volumes"
    printf_green "Removed $count volume(s)"
  else
    printf_yellow "No volumes to remove from pool: $storage"
  fi
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__prune_images() {
  local images="$(incus image list -c f -f csv 2>/dev/null | grep '^')"
  local count=0
  if [ -n "$images" ]; then
    printf_cyan "Removing unused images..."
    while IFS= read -r fingerprint; do
      [ -z "$fingerprint" ] && continue
      printf_blue "  Deleting image: $fingerprint"
      if incus image delete "$fingerprint" &>/dev/null; then
        printf_green "    ✓ Deleted image"
        count=$((count + 1))
      else
        printf_red "    ✗ Failed to delete image"
      fi
    done <<<"$images"
    printf_green "Removed $count image(s)"
  else
    printf_yellow "No images to remove"
  fi
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__prune_all() {
  printf_purple "========================================="
  printf_cyan "Starting cleanup operation..."
  printf_purple "========================================="
  __prune_instances
  __prune_volumes "$INCUSMGR_DEFAULT_STORAGE"
  __prune_images
  printf_purple "========================================="
  printf_green "Cleanup complete"
  printf_purple "========================================="
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__init() {
  __cmd_exists incus || printf_exit "Incus is not installed. Please install Incus first."
  if ! incus list &>/dev/null; then
    printf_cyan "Initializing Incus..."
    if incus admin init --auto &>/dev/null; then
      printf_green "Incus initialized successfully"
    else
      printf_red "Failed to initialize Incus"
      return 1
    fi
  else
    printf_green "Incus is already initialized"
  fi
  __gen_config
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__show_status() {
  printf_cyan "Incus Status:"
  printf_line "=============================================="
  if incus list &>/dev/null; then
    printf_green "✓ Incus daemon is running"
    printf_line ""
    printf_cyan "Version Information:"
    incus version 2>/dev/null | grep '^' || printf_yellow "Unable to get version"
    printf_line ""
    printf_cyan "Storage Pools:"
    incus storage list 2>/dev/null | grep '^' || printf_yellow "No storage pools"
    printf_line ""
    printf_cyan "Networks:"
    incus network list 2>/dev/null | grep '^' || printf_yellow "No networks"
    printf_line ""
    printf_cyan "Instances:"
    incus list 2>/dev/null | grep '^' || printf_yellow "No instances"
  else
    printf_red "✗ Incus daemon is not running or not accessible"
    return 1
  fi
  printf_line "=============================================="
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
__show_network_info() {
  local network="${1:-$INCUSMGR_DEFAULT_NETWORK}"
  if ! __network_exists "$network"; then
    printf_red "Network '$network' does not exist"
    return 1
  fi
  printf_cyan "Network Information: $network"
  printf_line "=============================================="
  incus network show "$network" 2>/dev/null
  printf_line ""
  printf_cyan "Instances on network $network:"
  incus list -c ns4 2>/dev/null | grep -A 100 'NAME' || printf_yellow "No instances found"
  printf_line "=============================================="
  return 0
}
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Set variables
INCUSMGR_EXIT_STATUS=0
INCUSMGR_CONFIG_DIR="${INCUSMGR_CONFIG_DIR:-$HOME/.config/myscripts/incusmgr}"
INCUSMGR_CONFIG_BACKUP_DIR="${INCUSMGR_CONFIG_BACKUP_DIR:-$HOME/.local/share/myscripts/incusmgr/backups}"
INCUSMGR_CONFIG_FILE="${INCUSMGR_CONFIG_FILE:-settings.conf}"
INCUSMGR_LOG_DIR="${INCUSMGR_LOG_DIR:-$HOME/.local/log/incusmgr}"
INCUSMGR_CACHE_DIR="${INCUSMGR_CACHE_DIR:-$HOME/.cache/incusmgr}"
INCUSMGR_TEMP_DIR="${INCUSMGR_TEMP_DIR:-$HOME/.local/tmp/system_scripts/incusmgr}"
INCUSMGR_INCUS_BIN="${INCUSMGR_INCUS_BIN:-incus}"
INCUSMGR_DEFAULT_STORAGE="${INCUSMGR_DEFAULT_STORAGE:-default}"
INCUSMGR_DEFAULT_NETWORK="${INCUSMGR_DEFAULT_NETWORK:-incusbr0}"
INCUSMGR_DEFAULT_PROFILE="${INCUSMGR_DEFAULT_PROFILE:-default}"
INCUSMGR_GOOD_MESSAGE="${INCUSMGR_GOOD_MESSAGE:-Everything Went OK}"
INCUSMGR_ERROR_MESSAGE="${INCUSMGR_ERROR_MESSAGE:-Well something seems to have gone wrong}"
INCUSMGR_NOTIFY_ENABLED="${INCUSMGR_NOTIFY_ENABLED:-yes}"
INCUSMGR_NOTIFY_CLIENT_NAME="${NOTIFY_CLIENT_NAME:-$APPNAME}"
INCUSMGR_OUTPUT_COLOR="${INCUSMGR_OUTPUT_COLOR:-5}"
INCUSMGR_OUTPUT_COLOR_GOOD="${INCUSMGR_OUTPUT_COLOR_GOOD:-2}"
INCUSMGR_OUTPUT_COLOR_ERROR="${INCUSMGR_OUTPUT_COLOR_ERROR:-1}"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Generate config
[ -f "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE" ] || [ "$*" = "--config" ] || INIT_CONFIG="${INIT_CONFIG:-TRUE}" __gen_config ${SETARGS:-$@}
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Import config
[ -f "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE" ] && . "$INCUSMGR_CONFIG_DIR/$INCUSMGR_CONFIG_FILE"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Ensure directories exist
[ -d "$INCUSMGR_LOG_DIR" ] || mkdir -p "$INCUSMGR_LOG_DIR" &>/dev/null
[ -d "$INCUSMGR_TEMP_DIR" ] || mkdir -p "$INCUSMGR_TEMP_DIR" &>/dev/null
[ -d "$INCUSMGR_CACHE_DIR" ] || mkdir -p "$INCUSMGR_CACHE_DIR" &>/dev/null
INCUSMGR_TEMP_FILE="${INCUSMGR_TEMP_FILE:-$(mktemp $INCUSMGR_TEMP_DIR/XXXXXX 2>/dev/null)}"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Set additional variables/Argument/Option settings
SETARGS=("$@")
SHORTOPTS="f"
SHORTOPTS+=""
LONGOPTS="force,help,config,version,options,debug,raw"
LONGOPTS+=""
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Setup application options
setopts=$(getopt -o "$SHORTOPTS" --long "$LONGOPTS" -n "$APPNAME" -- "$@" 2>/dev/null)
eval set -- "${setopts[@]}" 2>/dev/null
while :; do
  case "$1" in
  --raw)
    shift 1
    export SHOW_RAW="true"
    ;;
  --debug)
    shift 1
    set -xo pipefail
    export SCRIPT_OPTS="--debug"
    export _DEBUG="on"
    ;;
  --options)
    shift 1
    printf_blue "Current options for ${PROG:-$APPNAME}"
    [ -z "$SHORTOPTS" ] || __list_options "Short Options" "-${SHORTOPTS}" ',' '-' 4
    [ -z "$LONGOPTS" ] || __list_options "Long Options" "--${LONGOPTS}" ',' '--' 4
    exit $?
    ;;
  --version)
    shift 1
    printf_exit "${APPNAME:-$PROG} - Version: ${VERSION}"
    ;;
  --help)
    shift 1
    __help
    exit $?
    ;;
  --config)
    shift 1
    __gen_config
    exit $?
    ;;
  -f | --force)
    shift 1
    export FORCE_INSTALL="true"
    ;;
  --)
    shift 1
    break
    ;;
  esac
done
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Check for incus
__cmd_exists incus || printf_exit "Incus is not installed"
# - - - - - - - - - - - - - - - - - - - - - - - - -
# Main application
case "$1" in
init)
  shift 1
  __init
  exit $?
  ;;

status)
  shift 1
  __show_status
  exit $?
  ;;

version)
  shift 1
  incus version
  exit $?
  ;;

list | ls)
  shift 1
  if [ $# -eq 0 ]; then
    incus list
  else
    incus list "$@"
  fi
  exit $?
  ;;

info)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME info <instance>"
  incus info "$@"
  exit $?
  ;;

launch | run)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME launch <image> [name]"
  incus launch "$@"
  exit $?
  ;;

start)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME start <instance>"
  incus start "$@"
  exit $?
  ;;

stop)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME stop <instance>"
  incus stop "$@"
  exit $?
  ;;

restart)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME restart <instance>"
  incus restart "$@"
  exit $?
  ;;

delete | rm)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME delete <instance>"
  if [ "$FORCE_INSTALL" = "true" ]; then
    incus delete --force "$@"
  else
    incus delete "$@"
  fi
  exit $?
  ;;

exec)
  shift 1
  [ $# -lt 2 ] && printf_exit "Usage: $APPNAME exec <instance> <command>"
  instance="$1"
  shift 1
  if __instance_exists "$instance" && __instance_is_running "$instance"; then
    incus exec "$instance" -- "$@"
  else
    printf_exit "Instance '$instance' does not exist or is not running"
  fi
  exit $?
  ;;

enter | shell)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME enter <instance>"
  instance="$1"
  shift 1
  if __instance_exists "$instance"; then
    if ! __instance_is_running "$instance"; then
      printf_cyan "Starting instance: $instance"
      incus start "$instance" &>/dev/null
      sleep 2
    fi
    incus exec "$instance" -- /bin/bash || incus exec "$instance" -- /bin/sh
  else
    printf_exit "Instance '$instance' does not exist"
  fi
  exit $?
  ;;

rename | mv)
  shift 1
  [ $# -ne 2 ] && printf_exit "Usage: $APPNAME rename <old-name> <new-name>"
  incus rename "$@"
  exit $?
  ;;

snapshot)
  shift 1
  [ $# -eq 0 ] && printf_exit "Usage: $APPNAME snapshot <instance> [snapshot-name]"
  incus snapshot "$@"
  exit $?
  ;;

restore)
  shift 1
  [ $# -lt 2 ] && printf_exit "Usage: $APPNAME restore <instance> <snapshot>"
  incus restore "$@"
  exit $?
  ;;

storage)
  shift 1
  case "$1" in
  list | ls)
    shift 1
    incus storage list
    ;;
  create)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME storage create <name>"
    incus storage create "$@"
    ;;
  delete | rm)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME storage delete <name>"
    incus storage delete "$@"
    ;;
  show | info)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME storage show <name>"
    incus storage show "$@"
    ;;
  *)
    incus storage "$@"
    ;;
  esac
  exit $?
  ;;

network)
  shift 1
  case "$1" in
  list | ls)
    shift 1
    incus network list
    ;;
  create)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME network create <name>"
    incus network create "$@"
    ;;
  delete | rm)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME network delete <name>"
    incus network delete "$@"
    ;;
  show | info)
    shift 1
    if [ $# -eq 0 ]; then
      __show_network_info "$INCUSMGR_DEFAULT_NETWORK"
    else
      __show_network_info "$1"
    fi
    ;;
  *)
    incus network "$@"
    ;;
  esac
  exit $?
  ;;

profile)
  shift 1
  case "$1" in
  list | ls)
    shift 1
    incus profile list
    ;;
  show | info)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME profile show <name>"
    incus profile show "$@"
    ;;
  create)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME profile create <name>"
    incus profile create "$@"
    ;;
  delete | rm)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME profile delete <name>"
    incus profile delete "$@"
    ;;
  *)
    incus profile "$@"
    ;;
  esac
  exit $?
  ;;

image)
  shift 1
  case "$1" in
  list | ls)
    shift 1
    incus image list "$@"
    ;;
  info | show)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME image info <image>"
    incus image info "$@"
    ;;
  delete | rm)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME image delete <image>"
    incus image delete "$@"
    ;;
  copy | cp)
    shift 1
    [ $# -lt 2 ] && printf_exit "Usage: $APPNAME image copy <source> <destination>"
    incus image copy "$@"
    ;;
  *)
    incus image "$@"
    ;;
  esac
  exit $?
  ;;

remote)
  shift 1
  case "$1" in
  list | ls)
    shift 1
    incus remote list
    ;;
  add)
    shift 1
    [ $# -lt 2 ] && printf_exit "Usage: $APPNAME remote add <name> <url>"
    incus remote add "$@"
    ;;
  remove | rm)
    shift 1
    [ $# -eq 0 ] && printf_exit "Usage: $APPNAME remote remove <name>"
    incus remote remove "$@"
    ;;
  *)
    incus remote "$@"
    ;;
  esac
  exit $?
  ;;

prune)
  shift 1
  case "$1" in
  instances | containers)
    shift 1
    __prune_instances
    ;;
  volumes | storage)
    shift 1
    __prune_volumes "${1:-$INCUSMGR_DEFAULT_STORAGE}"
    ;;
  images)
    shift 1
    __prune_images
    ;;
  all | "")
    __prune_all
    ;;
  *)
    printf_exit "Usage: $APPNAME prune [instances|volumes|images|all]"
    ;;
  esac
  exit $?
  ;;

*)
  if [ $# -ne 0 ]; then
    incus "$@"
  else
    __help
  fi
  exit $?
  ;;
esac
# - - - - - - - - - - - - - - - - - - - - - - - - -
# End application
# - - - - - - - - - - - - - - - - - - - - - - - - -
# lets exit with code
exit ${INCUSMGR_EXIT_STATUS:-0}
# - - - - - - - - - - - - - - - - - - - - - - - - -
# ex: ts=2 sw=2 et filetype=sh
